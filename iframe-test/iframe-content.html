<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>iframe 모던 UI + focus input rAF scroll</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap");

            html,
            body {
                margin: 0;
                padding: 0;
                font-family: "Inter", sans-serif;
                background: #f4f6f8;
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
            }

            .container {
                width: 90%;
                max-width: 480px;
                margin-top: 40px;
                display: flex;
                flex-direction: column;
                gap: 24px;
            }

            .input-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            .input-group label {
                font-size: 14px;
                color: #6b7280;
            }
            .input-group input {
                padding: 14px 16px;
                font-size: 16px;
                border-radius: 12px;
                border: 1px solid #d1d5db;
                background: #ffffff;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                outline: none;
                transition: all 0.2s ease;
            }
            .input-group input:focus {
                border-color: #3b82f6;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            }

            button {
                padding: 14px;
                font-size: 16px;
                border-radius: 12px;
                border: none;
                cursor: pointer;
                background: #3b82f6;
                color: white;
                font-weight: 500;
                transition: all 0.2s ease;
            }
            button:hover {
                background: #2563eb;
            }

            .popup-bg {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(31, 41, 55, 0.25);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
                z-index: 998;
            }
            .popup-bg.active {
                opacity: 1;
                pointer-events: all;
            }

            .popup {
                position: fixed;
                left: 50%;
                bottom: -100%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 480px;
                height: 360px;
                background: #ffffff;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
                display: flex;
                flex-direction: column;
                padding: 24px;
                gap: 16px;
                transition: bottom 0.3s ease;
                overflow-y: auto;
                z-index: 999;
            }
            .popup.active {
                bottom: 0;
            }

            .popup h4 {
                margin: 0;
                color: #111827;
                font-weight: 500;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="input-group">
                <label for="name">이름</label>
                <input id="name" type="text" placeholder="홍길동" />
            </div>

            <div class="input-group">
                <label for="email">이메일</label>
                <input
                    id="email"
                    type="email"
                    placeholder="example@gmail.com"
                />
            </div>

            <div class="input-group">
                <label for="phone">전화번호</label>
                <input
                    id="phone"
                    type="tel"
                    placeholder="010-1234-5678"
                    inputmode="numeric"
                />
            </div>

            <div class="input-group">
                <label for="address">주소</label>
                <input
                    id="address"
                    type="text"
                    placeholder="서울시 강남구 ..."
                />
            </div>

            <button id="openPopup">하단 팝업 열기</button>
        </div>

        <div class="popup-bg" id="popupBg"></div>

        <div class="popup" id="popup">
            <h4>📋 팝업 내부</h4>

            <div class="input-group">
                <label for="popup1">팝업 이름</label>
                <input id="popup1" type="text" placeholder="홍길동" />
            </div>
            <div class="input-group">
                <label for="popup2">팝업 이메일</label>
                <input
                    id="popup2"
                    type="email"
                    placeholder="example@gmail.com"
                />
            </div>
            <div class="input-group">
                <label for="popup3">팝업 전화번호</label>
                <input
                    id="popup3"
                    type="tel"
                    placeholder="010-1234-5678"
                    inputmode="numeric"
                />
            </div>
            <div class="input-group">
                <label for="popup4">팝업 주소</label>
                <input
                    id="popup4"
                    type="text"
                    placeholder="서울시 강남구 ..."
                />
            </div>

            <button id="closePopup">닫기</button>
        </div>

        <script>
            class InputScrollManager {
                constructor(popup) {
                    this.popup = popup;
                    this.currentInput = null;
                    this.rAFId = null;
                    this.inputValues = {};

                    if (window.visualViewport) {
                        window.visualViewport.addEventListener("resize", () =>
                            this.onViewportChange()
                        );
                        window.visualViewport.addEventListener("scroll", () =>
                            this.onViewportChange()
                        );
                    }
                }

                focusInput(input) {
                    this.currentInput = input;
                    if (this.rAFId) cancelAnimationFrame(this.rAFId);

                    const loop = () => {
                        if (!this.currentInput) return;
                        this.adjustScroll(this.currentInput);
                        this.rAFId = requestAnimationFrame(loop);
                    };

                    this.rAFId = requestAnimationFrame(loop);
                }

                blurInput() {
                    this.currentInput = null;
                    if (this.rAFId) cancelAnimationFrame(this.rAFId);
                }

                inputEvent(input) {
                    if (input.type === "tel")
                        input.value = input.value.replace(/[^\d-]/g, "");
                    this.inputValues[input.id] = input.value;
                }

                onViewportChange() {
                    if (this.currentInput) this.adjustScroll(this.currentInput);
                }

                adjustScroll(targetInput) {
                    const rect = targetInput.getBoundingClientRect();
                    const viewportHeight = window.visualViewport
                        ? window.visualViewport.height
                        : window.innerHeight;
                    const isInPopup = this.popup.contains(targetInput);

                    if (isInPopup) {
                        const targetScroll =
                            this.popup.scrollTop +
                            rect.top -
                            viewportHeight / 2;
                        this.popup.scrollTo({
                            top: targetScroll,
                            behavior: "smooth",
                        });
                    } else {
                        const offsetTop = rect.top + window.scrollY;
                        const targetY =
                            offsetTop - viewportHeight / 2 + rect.height;
                        window.scrollTo({ top: targetY, behavior: "smooth" });
                    }
                }
            }

            // 초기화
            const popupEl = document.getElementById("popup");
            const manager = new InputScrollManager(popupEl);

            // 모든 input focus/blur 이벤트 연결
            document.querySelectorAll("input").forEach((input) => {
                input.addEventListener("focus", () =>
                    manager.focusInput(input)
                );
                input.addEventListener("blur", () => manager.blurInput());
                input.addEventListener("input", () =>
                    manager.inputEvent(input)
                );
            });

            // 팝업 열기/닫기
            const popupBg = document.getElementById("popupBg");
            document
                .getElementById("openPopup")
                .addEventListener("click", () => {
                    popupEl.classList.add("active");
                    popupBg.classList.add("active");
                });
            const closePopup = () => {
                popupEl.classList.remove("active");
                popupBg.classList.remove("active");
            };
            document
                .getElementById("closePopup")
                .addEventListener("click", closePopup);
            popupBg.addEventListener("click", closePopup);
        </script>
    </body>
</html>
